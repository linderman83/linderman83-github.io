(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{468:function(e,a,t){"use strict";t.r(a);var s=t(16),r=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"create-and-access-cloudflare-tunnel-to-remote-mysql-server-cli"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#create-and-access-cloudflare-tunnel-to-remote-mysql-server-cli"}},[e._v("#")]),e._v(" Create and access cloudflare tunnel to remote mysql server (cli)")]),e._v(" "),t("p",[e._v("Cloudflare had pretty good and simple UI dashboard, that can be used to create and manage tunnels, but this post shows how to do it from the cli.")]),e._v(" "),t("p",[e._v("This base example below is straight-forward, stript out of details and can give you idea of how Cloudflare tunnels can be used for other implementations and services.")]),e._v(" "),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"preparation"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#preparation"}},[e._v("#")]),e._v(" Preparation:")]),e._v(" "),t("h3",{attrs:{id:"install-cloudflared-cli-tool"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#install-cloudflared-cli-tool"}},[e._v("#")]),e._v(" Install cloudflared cli tool:")]),e._v(" "),t("p",[e._v("https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/")]),e._v(" "),t("br"),e._v(" "),t("h3",{attrs:{id:"if-you-have-warp-cli-installed-and-started-you-should-disable-it-temporary"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#if-you-have-warp-cli-installed-and-started-you-should-disable-it-temporary"}},[e._v("#")]),e._v(" If you have warp-cli installed and started, you should disable it temporary:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ warp-cli disconnect\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ warp-cli delete \n")])])]),t("br"),e._v(" "),t("h3",{attrs:{id:"make-sure-websockets-are-enabled-in"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#make-sure-websockets-are-enabled-in"}},[e._v("#")]),e._v(" Make sure WebSockets are enabled in")]),e._v(" "),t("p",[e._v("dash.cloudflare.com -> [ZoneName] -> Network")]),e._v(" "),t("br"),e._v(" "),t("h3",{attrs:{id:"if-you-use-mysql-inside-docker-container"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#if-you-use-mysql-inside-docker-container"}},[e._v("#")]),e._v(" If you use mysql inside docker container:")]),e._v(" "),t("p",[e._v("Make sure to use host networking mode. Mysql container service  should be accessible from the host. To do that use:")]),e._v(" "),t("p",[e._v("docker-compose:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("services:\n    mysql:\n        image: mysql:5.7.40\n        container_name: my-mysql\n        network_mode: host\n        ...\n    ...\n")])])]),t("p",[e._v("docker cli:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("docker run ... --network host ... --name my-mysql\n")])])]),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"_1-authenticate-cloudflared-with-an-cloudflare-account-and-choose-a-zone"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-authenticate-cloudflared-with-an-cloudflare-account-and-choose-a-zone"}},[e._v("#")]),e._v(" 1. Authenticate cloudflared with an Cloudflare account and choose a zone:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ cloudflared tunnel login\n")])])]),t("p",[e._v("The command will open new browser tab and require you to login in Cloudflare dashboard with your username and password. After that, you have to choose a zone to authorize agains.")]),e._v(" "),t("p",[e._v("On success, certificate will be generated and saved inside your .cloudflared directory, which is usually in your user root: "),t("code",[e._v("/home/username/.cloudflared/cert.pem")])]),e._v(" "),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"_2-create-new-tunnel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-create-new-tunnel"}},[e._v("#")]),e._v(" 2. Create new tunnel")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cloudflared tunnel create my-mysql-tunnel\n")])])]),t("p",[e._v("In your .cloudflared folder, you should now see a .json file, which represents newly created tunnel id.")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("ls .cloudflared/\n4554bd9a-62b2-4d9a-bf3t-dgbv8605c5zb.json  cert.pem\n")])])]),t("p",[e._v("Also, in Cloudflare Zero-Trust Dashboard, you should see your new tunnel.")]),e._v(" "),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"_3-create-configuration-file"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-create-configuration-file"}},[e._v("#")]),e._v(" 3. Create configuration file")]),e._v(" "),t("p",[e._v("This is needed for the tunnel to know, what will be server through it and how to access it.")]),e._v(" "),t("p",[e._v("Create new /home/username/.cloudflared/config.yml file:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("url: tcp://localhost:3306\ntunnel: 4554bd9a-62b2-4d9a-bf3t-dgbv8605c5zb\ncredentials-file: /home/username/.cloudflared/4554bd9a-62b2-4d9a-bf3t-dgbv8605c5zb.json\n")])])]),t("p",[e._v("As you can see in "),t("code",[e._v("url")]),e._v(" parameter, the tunnel access point is to my locally accessible 3306 (mysql server default port). Important to notice is the "),t("strong",[e._v("tcp://")]),e._v(" protocol used.")]),e._v(" "),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"_4-create-dns-record-for-this-tunnel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-create-dns-record-for-this-tunnel"}},[e._v("#")]),e._v(" 4. Create DNS record for this tunnel")]),e._v(" "),t("p",[e._v("It is clear, that you will want to access the mysql instance remotely vie the tunnel. For this you need to create new DNS record in the zone, you choosed earlier:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cloudflared tunnel route dns my-mysql-tunnel mysql.domain.com\n")])])]),t("p",[e._v("or using the tunnel ID")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cloudflared tunnel route dns 4554bd9a-62b2-4d9a-bf3t-dgbv8605c5zb mysql.domain.com\n")])])]),t("p",[e._v("If you now go to Cloudflare Dashboard, in your selected zone DNS section, you will see new CNAME record created.")]),e._v(" "),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"_5-start-the-tunnel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-start-the-tunnel"}},[e._v("#")]),e._v(" 5. Start the tunnel")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cloudflared tunnel --config /home/username/.cloudflared/config.yml run 4554bd9a-62b2-4d9a-bf3t-dgbv8605c5zb\n")])])]),t("p",[e._v("shorthand command:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cloudflared tunnel run my-mysql-tunnel\n")])])]),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"almost-done-to-access-the-tunnel-remotely-on-the-client-machine-run"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#almost-done-to-access-the-tunnel-remotely-on-the-client-machine-run"}},[e._v("#")]),e._v(" Almost done: to access the tunnel remotely, on the client machine, run:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cloudflared access tcp --hostname mysql.domain.com --url localhost:3366\n")])])]),t("p",[e._v("Where:")]),e._v(" "),t("p",[e._v("--hostname: is the DNS record, address of the tunnel\n--url: local port to be used on the clients side of the tunnel")]),e._v(" "),t("p",[e._v("Now, cloudflared uses "),t("strong",[e._v("tcp")]),e._v(" protocol to connect to a tunnel, located at "),t("strong",[e._v("mysql.domain.com")]),e._v(" and makes it available locally on port "),t("strong",[e._v("localhost:3366")])]),e._v(" "),t("br"),e._v(" "),t("br"),e._v(" "),t("h2",{attrs:{id:"finally-connect-to-the-remove-mysql-server-via-the-tunnel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#finally-connect-to-the-remove-mysql-server-via-the-tunnel"}},[e._v("#")]),e._v(" Finally, connect to the remove mysql server via the tunnel:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("mysql -h localhost -P3366 --protocol=tcp -u root -p\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);